import { friendService } from "../../utils/friendService";
import { friendWebSocketManager } from "../../utils/friendWebSocket";
import { getFriendComponentTemplate } from "./FriendTemplate";
import { UserProfileManager } from "./UserProfileManager";
import { FriendDataManager } from "./FriendDataManager";
import { FriendUIRenderer } from "./FriendUIRenderer";
import { FriendEventHandler } from "./FriendEventHandler";

export class FriendComponent {
  private container: HTMLElement;
  private userProfileManager!: UserProfileManager;
  private dataManager!: FriendDataManager;
  private uiRenderer!: FriendUIRenderer;
  private eventHandler!: FriendEventHandler;

  constructor(container: HTMLElement) {
    this.container = container;
    this.initializeComponents();
    this.initialize();
  }

  private initializeComponents(): void {
    this.userProfileManager = new UserProfileManager(this.container);
    this.dataManager = new FriendDataManager(this.userProfileManager);
    this.uiRenderer = new FriendUIRenderer(this.container);
    this.eventHandler = new FriendEventHandler(
      this.dataManager,
      this.userProfileManager,
      () => this.renderFriendItems(),
      (message: string) => this.showNotification(message)
    );
  }

  private async initialize(): Promise<void> {
    this.render();
    this.setupEventListeners();
    this.setupWebSocket();
    this.requestNotificationPermission();

    await this.userProfileManager.setupUserProfile();
    await this.loadFriendsData();
  }

  public render(): void {
    this.container.innerHTML = getFriendComponentTemplate();
  }

  private setupWebSocket(): void {
    friendWebSocketManager.connect();
    friendWebSocketManager.onFriendNotificationReceived(this.handleWebSocketMessage.bind(this));
  }

  private handleWebSocketMessage(data: any): void {
    this.eventHandler.handleFriendNotification(data);
  }

  private requestNotificationPermission(): void {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  }

  private showNotification(message: string): void {
    if (Notification.permission === "granted") {
      new Notification("ÏπúÍµ¨ ÏïåÎ¶º", {
        body: message,
        icon: "/favicon.ico",
        tag: "friend-notification",
        requireInteraction: false,
        silent: false,
      });
    }
  }

  private async loadFriendsData(): Promise<void> {
    try {
      await this.dataManager.loadAllData();
      this.renderFriendItems();
    } catch (error) {
      console.error("ÏπúÍµ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:", error);
      this.renderFriendItems();
    }
  }

  private setupEventListeners(): void {
    // DOMÏù¥ ÏôÑÏ†ÑÌûà Î†åÎçîÎßÅÎê† ÎïåÍπåÏßÄ ÏïΩÍ∞Ñ ÎåÄÍ∏∞
    setTimeout(() => {
      this.setupMobileToggleListeners();
      this.setupDropdownToggleListeners();
      this.setupFriendActionListeners();
      this.setupDocumentClickListener();
    }, 100);
  }

  private setupMobileToggleListeners(): void {
    // container ÏïàÏóêÏÑú Ï∞æÍ∏∞
    const toggleButtonInContainer = this.container.querySelector("#mobile-friend-toggle");
    const closeButtonInContainer = this.container.querySelector("#friend-close-btn");
    const overlayInContainer = this.container.querySelector("#friend-overlay");

    // document Ï†ÑÏ≤¥ÏóêÏÑú Ï∞æÍ∏∞
    const toggleButtonInDocument = document.querySelector("#mobile-friend-toggle");
    const closeButtonInDocument = document.querySelector("#friend-close-btn");
    const overlayInDocument = document.querySelector("#friend-overlay");

    // Ïã§Ï†ú ÏÇ¨Ïö©Ìï† ÏöîÏÜåÎì§ (Ïö∞ÏÑ†ÏàúÏúÑ: container > document)
    const toggleButton = toggleButtonInContainer || toggleButtonInDocument;
    const closeButton = closeButtonInContainer || closeButtonInDocument;
    const overlay = overlayInContainer || overlayInDocument;

    // ÌÜ†Í∏Ä Î≤ÑÌäº ÌÅ¥Î¶≠
    if (toggleButton) {
      toggleButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.openFriendPanel();
      });
    }

    // Îã´Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
    if (closeButton) {
      closeButton.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.closeFriendPanel();
      });
    }

    // Ïò§Î≤ÑÎ†àÏù¥ ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
    if (overlay) {
      overlay.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.closeFriendPanel();
      });
    }

    // ESC ÌÇ§Î°ú Îã´Í∏∞ (Î™®Î∞îÏùºÏóêÏÑúÎßå)
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && window.innerWidth < 1024) {
        this.closeFriendPanel();
      }
    });

    // Ï∞Ω ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω Ïãú Ï≤òÎ¶¨
    window.addEventListener("resize", () => {
      if (window.innerWidth >= 1024) {
        this.closeFriendPanel();
      }
    });
  }

  private openFriendPanel(): void {
    // container ÏïàÏóêÏÑú Ï∞æÍ∏∞
    const panelInContainer = this.container.querySelector("#friend-panel");
    const overlayInContainer = this.container.querySelector("#friend-overlay");

    // document Ï†ÑÏ≤¥ÏóêÏÑú Ï∞æÍ∏∞
    const panelInDocument = document.querySelector("#friend-panel");
    const overlayInDocument = document.querySelector("#friend-overlay");

    // Ïã§Ï†ú ÏÇ¨Ïö©Ìï† ÏöîÏÜåÎì§
    const panel = panelInContainer || panelInDocument;
    const overlay = overlayInContainer || overlayInDocument;

    if (panel && overlay) {
      panel.classList.add("show");
      overlay.classList.add("show");

      // Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
      document.body.classList.add("friend-overflow-hidden");
    }
  }

  private closeFriendPanel(): void {
    // container ÏïàÏóêÏÑú Ï∞æÍ∏∞
    const panelInContainer = this.container.querySelector("#friend-panel");
    const overlayInContainer = this.container.querySelector("#friend-overlay");

    // document Ï†ÑÏ≤¥ÏóêÏÑú Ï∞æÍ∏∞
    const panelInDocument = document.querySelector("#friend-panel");
    const overlayInDocument = document.querySelector("#friend-overlay");

    // Ïã§Ï†ú ÏÇ¨Ïö©Ìï† ÏöîÏÜåÎì§
    const panel = panelInContainer || panelInDocument;
    const overlay = overlayInContainer || overlayInDocument;

    if (panel && overlay) {
      panel.classList.remove("show");
      overlay.classList.remove("show");

      // Ïä§ÌÅ¨Î°§ Î≥µÏõê
      document.body.classList.remove("friend-overflow-hidden");
    }
  }

  private setupDropdownToggleListeners(): void {
    // DOMÏù¥ ÏôÑÏ†ÑÌûà Î°úÎìúÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
    setTimeout(() => {
      const requestsToggle = this.container.querySelector("#requestsToggle");
      const requestsDropdown = this.container.querySelector("#requestsDropdown");
      const sentRequestsToggle = this.container.querySelector("#sentRequestsToggle");
      const sentRequestsDropdown = this.container.querySelector("#sentRequestsDropdown");

      if (requestsToggle) {
        requestsToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          this.toggleRequestsDropdown(requestsDropdown);
        });
      }

      if (sentRequestsToggle) {
        sentRequestsToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          this.toggleRequestsDropdown(sentRequestsDropdown);
        });
      }
    }, 100);
  }

  private setupFriendActionListeners(): void {
    this.container.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;

      if (target.id === "addFriendBtn" || target.closest("#addFriendBtn")) {
        e.preventDefault();
        this.handleAddFriendClick();
        return;
      }

      this.handleContainerClick(e);
    });

    this.container.addEventListener("keypress", (e) => {
      if ((e.target as HTMLElement).id === "addFriendInput" && e.key === "Enter") {
        e.preventDefault();
        this.handleAddFriendClick();
      }
    });
  }

  private setupDocumentClickListener(): void {
    document.addEventListener("click", (e) => {
      if (!this.container.contains(e.target as Node)) {
        const requestsDropdown = this.container.querySelector("#requestsDropdown");
        const sentRequestsDropdown = this.container.querySelector("#sentRequestsDropdown");
        if (requestsDropdown) this.closeRequestsDropdown(requestsDropdown);
        if (sentRequestsDropdown) this.closeRequestsDropdown(sentRequestsDropdown);
      }
    });
  }

  private handleAddFriendClick(): void {
    const addFriendInput = this.container.querySelector("#addFriendInput") as HTMLInputElement;
    if (addFriendInput?.value.trim()) {
      this.addFriend(addFriendInput.value.trim());
    }
  }

  private toggleRequestsDropdown(dropdown: Element | null): void {
    if (!dropdown) {
      return;
    }

    const isVisible = dropdown.classList.contains("show");

    if (isVisible) {
      this.closeRequestsDropdown(dropdown);
    } else {
      this.openRequestsDropdown(dropdown);
    }
  }

  private openRequestsDropdown(dropdown: Element): void {
    dropdown.classList.add("show");
  }

  private closeRequestsDropdown(dropdown: Element): void {
    dropdown.classList.remove("show");
  }

  private handleContainerClick(e: Event): void {
    const target = e.target as HTMLElement;
    const text = target.textContent;

    if (target.id === "addFriendBtn" || target.closest("#addFriendBtn")) {
      return;
    }

    const requestItem = target.closest("[data-relation-id]");
    const sentRequestsList = this.container.querySelector("#sentRequestsList");

    if (text === "‚úó" && requestItem && sentRequestsList?.contains(requestItem)) {
      this.handleCancelSentRequest(target);
      return;
    }

    switch (text) {
      case "‚úì":
        this.handleAcceptRequest(target);
        break;
      case "‚úó":
        this.handleRejectRequest(target);
        break;
      case "üóëÔ∏è":
        this.handleDeleteFriend(target, e);
        break;
    }
  }

  private renderFriendItems(): void {
    const friends = this.dataManager.getFriends();
    const friendRequests = this.dataManager.getFriendRequests();
    const sentRequests = this.dataManager.getSentRequests();

    this.uiRenderer.renderFriendItems(friends, friendRequests, sentRequests);
    this.updateNotificationBadge(friendRequests.length);
  }

  private async addFriend(username: string): Promise<void> {
    if (!username.trim()) return;

    try {
      // ÏûêÍ∏∞ ÏûêÏã†ÏùÑ ÏπúÍµ¨Î°ú Ï∂îÍ∞ÄÌïòÎ†§Îäî Í≤ΩÏö∞ Î∞©ÏßÄ
      if (this.dataManager.isSelfUsername(username.trim())) {
        this.showNotification("ÏûêÍ∏∞ ÏûêÏã†ÏùÑ ÏπúÍµ¨Î°ú Ï∂îÍ∞ÄÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
      }

      // Ïù¥ÎØ∏ ÏπúÍµ¨Ïù∏ÏßÄ ÌôïÏù∏
      const existingFriend = this.dataManager
        .getFriends()
        .find((friend) => friend.username?.toLowerCase() === username.trim().toLowerCase());

      if (existingFriend) {
        this.showNotification("Ïù¥ÎØ∏ ÏπúÍµ¨Î°ú Îì±Î°ùÎêú ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§.");
        return;
      }

      // Ïù¥ÎØ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÎäîÏßÄ ÌôïÏù∏
      const existingSentRequest = this.dataManager
        .getSentRequests()
        .find((request) => request.username?.toLowerCase() === username.trim().toLowerCase());

      if (existingSentRequest) {
        this.showNotification("Ïù¥ÎØ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ∏ ÏÇ¨Ïö©ÏûêÏûÖÎãàÎã§.");
        return;
      }

      // Î∞õÏùÄ ÏπúÍµ¨ ÏöîÏ≤≠ Ï§ëÏóê Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
      const existingReceivedRequest = this.dataManager
        .getFriendRequests()
        .find((request) => request.username?.toLowerCase() === username.trim().toLowerCase());

      if (existingReceivedRequest) {
        this.showNotification("Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÎ°úÎ∂ÄÌÑ∞ Ïù¥ÎØ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î∞õÏïòÏäµÎãàÎã§. Î∞õÏùÄ ÏöîÏ≤≠ÏóêÏÑú ÏàòÎùΩÌï¥Ï£ºÏÑ∏Ïöî.");
        return;
      }

      const response = await friendService.requestFriend(username);

      if (response.success) {
        const input = this.container.querySelector("#addFriendInput") as HTMLInputElement;
        if (input) input.value = "";

        // Î≥¥ÎÇ∏ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ† ÏÉàÎ°úÍ≥†Ïπ®
        await this.dataManager.loadSentRequests();

        // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
        await this.dataManager.loadAllData();

        // UI ÏÉàÎ°úÍ≥†Ïπ®
        this.renderFriendItems();

        this.showNotification(`${username}ÎãòÏóêÍ≤å ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§.`);
      } else {
        const errorMsg = response.message || "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§";
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ Ïã§Ìå®: ${errorMsg}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private handleAcceptRequest(target: HTMLElement): void {
    const requestItem = target.closest("[data-relation-id]");
    const relationId = requestItem?.getAttribute("data-relation-id");
    const nameElement = requestItem?.querySelector(".friend-request-name");
    const requestName = nameElement?.textContent;

    if (relationId && requestName) {
      this.acceptFriendRequestById(relationId, requestName);
    }
  }

  private handleRejectRequest(target: HTMLElement): void {
    const requestItem = target.closest("[data-relation-id]");
    const relationId = requestItem?.getAttribute("data-relation-id");
    const nameElement = requestItem?.querySelector(".friend-request-name");
    const requestName = nameElement?.textContent;

    if (relationId && requestName) {
      this.rejectFriendRequestById(relationId, requestName);
    }
  }

  private handleDeleteFriend(target: HTMLElement, e: Event): void {
    e.preventDefault();
    e.stopPropagation();

    const friendItem = target.closest("[data-friend-id]");
    const friendId = friendItem?.getAttribute("data-friend-id");
    const nameElement = friendItem?.querySelector(".friend-item-name");
    const friendName = nameElement?.textContent?.trim();

    let finalFriendName = friendName;
    if (!finalFriendName && friendId) {
      const friend = this.dataManager.getFriend(friendId);
      finalFriendName = friend?.name || friend?.username || `ÏÇ¨Ïö©Ïûê${friendId}`;
    }

    if (friendId && finalFriendName) {
      this.deleteFriend(friendId, finalFriendName);
    }
  }

  private handleCancelSentRequest(target: HTMLElement): void {
    const requestItem = target.closest("[data-relation-id]");
    const relationId = requestItem?.getAttribute("data-relation-id");
    const nameElement = requestItem?.querySelector(".friend-request-name");
    const requestName = nameElement?.textContent;

    if (!relationId || !requestName) return;

    const sentRequest = this.dataManager
      .getSentRequests()
      .find((req) => req.relationId.toString() === relationId.toString());

    if (sentRequest) {
      // sentRequest.idÎäî Ïã§Ï†ú Î∞õÎäî ÏÇ¨ÎûåÏùò ID (receiverId)
      this.cancelFriendRequest(sentRequest.id, requestName);
    }
  }

  private async acceptFriendRequestById(relationId: string, friendName: string): Promise<void> {
    try {
      const response = await friendService.acceptFriendRequest(relationId);

      if (response.success) {
        await this.dataManager.loadAllData();
        this.renderFriendItems();
        this.closeAllDropdowns();
        this.showNotification(`${friendName}ÎãòÏù¥ ÏπúÍµ¨ Î™©Î°ùÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ ÏàòÎùΩ Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ ÏàòÎùΩ Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ ÏàòÎùΩ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private async rejectFriendRequestById(relationId: string, friendName: string): Promise<void> {
    try {
      const response = await friendService.rejectFriendRequest(relationId);

      if (response.success) {
        await this.dataManager.loadAllData();
        this.renderFriendItems();
        this.closeAllDropdowns();
        this.showNotification(`${friendName}ÎãòÏùò ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ Í±∞Ï†à Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ Í±∞Ï†à Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ Í±∞Ï†à Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private async deleteFriend(friendId: string, friendName: string): Promise<void> {
    if (!confirm(`Ï†ïÎßêÎ°ú ${friendName}ÎãòÏùÑ ÏπúÍµ¨ÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    try {
      const response = await friendService.deleteFriend(friendId);

      if (response.success) {
        await this.dataManager.loadAllData();
        this.renderFriendItems();
        this.showNotification(`${friendName}ÎãòÏùÑ ÏπúÍµ¨ÏóêÏÑú ÏÇ≠Ï†úÌñàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏÇ≠Ï†ú Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏÇ≠Ï†ú Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private async cancelFriendRequest(receiverId: string, receiverName: string): Promise<void> {
    if (!confirm(`Ï†ïÎßêÎ°ú ${receiverName}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    try {
      const response = await friendService.cancelFriendRequest(receiverId, receiverName);

      if (response.success) {
        // Î≥¥ÎÇ∏ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞Îßå ÏÉàÎ°úÍ≥†Ïπ®
        await this.dataManager.loadSentRequests();

        // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏÉàÎ°úÍ≥†Ïπ® (ÌòπÏãú Î™®Î•º ÎèôÍ∏∞Ìôî Ïù¥Ïäà Î∞©ÏßÄ)
        await this.dataManager.loadAllData();

        // UI Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
        this.renderFriendItems();

        // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
        this.closeAllDropdowns();

        this.showNotification(`${receiverName}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌñàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ Ï∑®ÏÜå Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ Ï∑®ÏÜå Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private closeAllDropdowns(): void {
    const requestsDropdown = this.container.querySelector("#requestsDropdown");
    const sentRequestsDropdown = this.container.querySelector("#sentRequestsDropdown");
    if (requestsDropdown) this.closeRequestsDropdown(requestsDropdown);
    if (sentRequestsDropdown) this.closeRequestsDropdown(sentRequestsDropdown);
  }

  private updateNotificationBadge(count: number): void {
    const badge = document.querySelector("#friend-notification-badge") as HTMLElement;
    if (badge) {
      if (count > 0) {
        badge.textContent = count.toString();
        badge.classList.add("show");
      } else {
        badge.classList.remove("show");
      }
    }
  }

  public destroy(): void {
    friendWebSocketManager.disconnect();

    // Ïä§ÌÅ¨Î°§ Î≥µÏõê
    document.body.classList.remove("friend-overflow-hidden");
  }
}
