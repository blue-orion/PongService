import { friendService } from "../../utils/friendService";
import { friendWebSocketManager } from "../../utils/friendWebSocket";
import { getFriendComponentTemplate } from "./FriendTemplate";
import { UserProfileManager } from "./UserProfileManager";
import { FriendDataManager } from "./FriendDataManager";
import { FriendUIRenderer } from "./FriendUIRenderer";
import { FriendEventHandler } from "./FriendEventHandler";

export class FriendComponent {
  private container: HTMLElement;
  private userProfileManager!: UserProfileManager;
  private dataManager!: FriendDataManager;
  private uiRenderer!: FriendUIRenderer;
  private eventHandler!: FriendEventHandler;

  constructor(container: HTMLElement) {
    this.container = container;
    this.initializeComponents();
    this.initialize();
  }

  private initializeComponents(): void {
    this.userProfileManager = new UserProfileManager(this.container);
    this.dataManager = new FriendDataManager(this.userProfileManager);
    this.uiRenderer = new FriendUIRenderer(this.container);
    this.eventHandler = new FriendEventHandler(
      this.dataManager,
      this.userProfileManager,
      () => this.renderFriendItems(),
      (message: string) => this.showNotification(message)
    );
  }

  private async initialize(): Promise<void> {
    this.render();
    this.setupEventListeners();
    this.setupWebSocket();
    this.requestNotificationPermission();

    await this.userProfileManager.setupUserProfile();
    await this.loadFriendsData();
  }

  private render(): void {
    this.container.innerHTML = getFriendComponentTemplate();
  }

  private setupWebSocket(): void {
    friendWebSocketManager.connect();
    friendWebSocketManager.onFriendNotificationReceived(this.handleWebSocketMessage.bind(this));
  }

  private handleWebSocketMessage(data: any): void {
    this.eventHandler.handleFriendNotification(data);
  }

  private requestNotificationPermission(): void {
    if ("Notification" in window && Notification.permission === "default") {
      Notification.requestPermission();
    }
  }

  private showNotification(message: string): void {
    if (Notification.permission === "granted") {
      new Notification("ÏπúÍµ¨ ÏïåÎ¶º", {
        body: message,
        icon: "/favicon.ico",
        tag: "friend-notification",
        requireInteraction: false,
        silent: false,
      });
    }
  }

  private async loadFriendsData(): Promise<void> {
    try {
      await this.dataManager.loadAllData();
      this.renderFriendItems();
    } catch (error) {
      console.error("ÏπúÍµ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:", error);
      this.renderFriendItems();
    }
  }

  private setupEventListeners(): void {
    this.setupDropdownToggleListeners();
    this.setupFriendActionListeners();
    this.setupDocumentClickListener();
  }

  private setupDropdownToggleListeners(): void {
    // DOMÏù¥ ÏôÑÏ†ÑÌûà Î°úÎìúÎê† ÎïåÍπåÏßÄ ÎåÄÍ∏∞
    setTimeout(() => {
      const requestsToggle = this.container.querySelector("#requestsToggle");
      const requestsDropdown = this.container.querySelector("#requestsDropdown");
      const sentRequestsToggle = this.container.querySelector("#sentRequestsToggle");
      const sentRequestsDropdown = this.container.querySelector("#sentRequestsDropdown");

      if (requestsToggle) {
        requestsToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          this.toggleRequestsDropdown(requestsDropdown);
        });
      }

      if (sentRequestsToggle) {
        sentRequestsToggle.addEventListener("click", (e) => {
          e.stopPropagation();
          e.preventDefault();
          this.toggleRequestsDropdown(sentRequestsDropdown);
        });
      }
    }, 100);
  }

  private setupFriendActionListeners(): void {
    this.container.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;

      if (target.id === "addFriendBtn" || target.closest("#addFriendBtn")) {
        e.preventDefault();
        this.handleAddFriendClick();
        return;
      }

      this.handleContainerClick(e);
    });

    this.container.addEventListener("keypress", (e) => {
      if ((e.target as HTMLElement).id === "addFriendInput" && e.key === "Enter") {
        e.preventDefault();
        this.handleAddFriendClick();
      }
    });
  }

  private setupDocumentClickListener(): void {
    document.addEventListener("click", (e) => {
      if (!this.container.contains(e.target as Node)) {
        const requestsDropdown = this.container.querySelector("#requestsDropdown");
        const sentRequestsDropdown = this.container.querySelector("#sentRequestsDropdown");
        if (requestsDropdown) this.closeRequestsDropdown(requestsDropdown);
        if (sentRequestsDropdown) this.closeRequestsDropdown(sentRequestsDropdown);
      }
    });
  }

  private handleAddFriendClick(): void {
    const addFriendInput = this.container.querySelector("#addFriendInput") as HTMLInputElement;
    if (addFriendInput?.value.trim()) {
      this.addFriend(addFriendInput.value.trim());
    }
  }

  private toggleRequestsDropdown(dropdown: Element | null): void {
    if (!dropdown) {
      return;
    }

    const isVisible = dropdown.classList.contains("opacity-100");

    if (isVisible) {
      this.closeRequestsDropdown(dropdown);
    } else {
      this.openRequestsDropdown(dropdown);
    }
  }

  private openRequestsDropdown(dropdown: Element): void {
    dropdown.classList.remove("opacity-0", "-translate-y-2.5", "pointer-events-none");
    dropdown.classList.add("opacity-100", "translate-y-0", "pointer-events-auto");
  }

  private closeRequestsDropdown(dropdown: Element): void {
    dropdown.classList.remove("opacity-100", "translate-y-0", "pointer-events-auto");
    dropdown.classList.add("opacity-0", "-translate-y-2.5", "pointer-events-none");
  }

  private handleContainerClick(e: Event): void {
    const target = e.target as HTMLElement;
    const text = target.textContent;

    if (target.id === "addFriendBtn" || target.closest("#addFriendBtn")) {
      return;
    }

    const requestItem = target.closest("[data-relation-id]");
    const sentRequestsList = this.container.querySelector("#sentRequestsList");

    if (text === "‚úó" && requestItem && sentRequestsList?.contains(requestItem)) {
      this.handleCancelSentRequest(target);
      return;
    }

    switch (text) {
      case "‚úì":
        this.handleAcceptRequest(target);
        break;
      case "‚úó":
        this.handleRejectRequest(target);
        break;
      case "üóëÔ∏è":
        this.handleDeleteFriend(target, e);
        break;
    }
  }

  private renderFriendItems(): void {
    const friends = this.dataManager.getFriends();
    const friendRequests = this.dataManager.getFriendRequests();
    const sentRequests = this.dataManager.getSentRequests();

    this.uiRenderer.renderFriendItems(friends, friendRequests, sentRequests);
  }

  private async addFriend(username: string): Promise<void> {
    if (!username.trim()) return;

    try {
      const response = await friendService.requestFriend(username);

      if (response.success) {
        const input = this.container.querySelector("#addFriendInput") as HTMLInputElement;
        if (input) input.value = "";

        // Î≥¥ÎÇ∏ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ïö∞ÏÑ† ÏÉàÎ°úÍ≥†Ïπ®
        await this.dataManager.loadSentRequests();

        // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
        await this.dataManager.loadAllData();

        // UI ÏÉàÎ°úÍ≥†Ïπ®
        this.renderFriendItems();

        this.showNotification(`${username}ÎãòÏóêÍ≤å ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§.`);
      } else {
        const errorMsg = response.message || "ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§";
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ Ïã§Ìå®: ${errorMsg}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private handleAcceptRequest(target: HTMLElement): void {
    const requestItem = target.closest("[data-relation-id]");
    const relationId = requestItem?.getAttribute("data-relation-id");
    const nameElement = requestItem?.querySelector(".text-gray-800");
    const requestName = nameElement?.textContent;

    if (relationId && requestName) {
      this.acceptFriendRequestById(relationId, requestName);
    }
  }

  private handleRejectRequest(target: HTMLElement): void {
    const requestItem = target.closest("[data-relation-id]");
    const relationId = requestItem?.getAttribute("data-relation-id");
    const nameElement = requestItem?.querySelector(".text-gray-800");
    const requestName = nameElement?.textContent;

    if (relationId && requestName) {
      this.rejectFriendRequestById(relationId, requestName);
    }
  }

  private handleDeleteFriend(target: HTMLElement, e: Event): void {
    e.preventDefault();
    e.stopPropagation();

    const friendItem = target.closest("[data-friend-id]");
    const friendId = friendItem?.getAttribute("data-friend-id");
    const nameElement = friendItem?.querySelector(".text-white");
    const friendName = nameElement?.textContent?.trim();

    let finalFriendName = friendName;
    if (!finalFriendName && friendId) {
      const friend = this.dataManager.getFriend(friendId);
      finalFriendName = friend?.name || friend?.username || `ÏÇ¨Ïö©Ïûê${friendId}`;
    }

    if (friendId && finalFriendName) {
      this.deleteFriend(friendId, finalFriendName);
    }
  }

  private handleCancelSentRequest(target: HTMLElement): void {
    const requestItem = target.closest("[data-relation-id]");
    const relationId = requestItem?.getAttribute("data-relation-id");
    const nameElement = requestItem?.querySelector(".text-gray-800");
    const requestName = nameElement?.textContent;

    if (!relationId || !requestName) return;

    const sentRequest = this.dataManager
      .getSentRequests()
      .find((req) => req.relationId.toString() === relationId.toString());

    if (sentRequest) {
      // sentRequest.idÎäî Ïã§Ï†ú Î∞õÎäî ÏÇ¨ÎûåÏùò ID (receiverId)
      this.cancelFriendRequest(sentRequest.id, requestName);
    }
  }

  private async acceptFriendRequestById(relationId: string, friendName: string): Promise<void> {
    try {
      const response = await friendService.acceptFriendRequest(relationId);

      if (response.success) {
        await this.dataManager.loadAllData();
        this.renderFriendItems();
        this.closeAllDropdowns();
        this.showNotification(`${friendName}ÎãòÏù¥ ÏπúÍµ¨ Î™©Î°ùÏóê Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ ÏàòÎùΩ Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ ÏàòÎùΩ Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ ÏàòÎùΩ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private async rejectFriendRequestById(relationId: string, friendName: string): Promise<void> {
    try {
      const response = await friendService.rejectFriendRequest(relationId);

      if (response.success) {
        await this.dataManager.loadAllData();
        this.renderFriendItems();
        this.closeAllDropdowns();
        this.showNotification(`${friendName}ÎãòÏùò ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ Í±∞Ï†à Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ Í±∞Ï†à Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ Í±∞Ï†à Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private async deleteFriend(friendId: string, friendName: string): Promise<void> {
    if (!confirm(`Ï†ïÎßêÎ°ú ${friendName}ÎãòÏùÑ ÏπúÍµ¨ÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    try {
      const response = await friendService.deleteFriend(friendId);

      if (response.success) {
        await this.dataManager.loadAllData();
        this.renderFriendItems();
        this.showNotification(`${friendName}ÎãòÏùÑ ÏπúÍµ¨ÏóêÏÑú ÏÇ≠Ï†úÌñàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏÇ≠Ï†ú Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏÇ≠Ï†ú Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private async cancelFriendRequest(receiverId: string, receiverName: string): Promise<void> {
    if (!confirm(`Ï†ïÎßêÎ°ú ${receiverName}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    try {
      const response = await friendService.cancelFriendRequest(receiverId, receiverName);

      if (response.success) {
        // Î≥¥ÎÇ∏ ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞Îßå ÏÉàÎ°úÍ≥†Ïπ®
        await this.dataManager.loadSentRequests();

        // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ÎèÑ ÏÉàÎ°úÍ≥†Ïπ® (ÌòπÏãú Î™®Î•º ÎèôÍ∏∞Ìôî Ïù¥Ïäà Î∞©ÏßÄ)
        await this.dataManager.loadAllData();

        // UI Í∞ïÏ†ú ÏÉàÎ°úÍ≥†Ïπ®
        this.renderFriendItems();

        // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
        this.closeAllDropdowns();

        this.showNotification(`${receiverName}ÎãòÏóêÍ≤å Î≥¥ÎÇ∏ ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ Ï∑®ÏÜåÌñàÏäµÎãàÎã§.`);
      } else {
        this.showNotification(`ÏπúÍµ¨ ÏöîÏ≤≠ Ï∑®ÏÜå Ïã§Ìå®: ${response.message || "ÏÑúÎ≤Ñ Ïò§Î•ò"}`);
      }
    } catch (error) {
      console.error("ÏπúÍµ¨ ÏöîÏ≤≠ Ï∑®ÏÜå Ïò§Î•ò:", error);
      this.showNotification("ÏπúÍµ¨ ÏöîÏ≤≠ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
    }
  }

  private closeAllDropdowns(): void {
    const requestsDropdown = this.container.querySelector("#requestsDropdown");
    const sentRequestsDropdown = this.container.querySelector("#sentRequestsDropdown");
    if (requestsDropdown) this.closeRequestsDropdown(requestsDropdown);
    if (sentRequestsDropdown) this.closeRequestsDropdown(sentRequestsDropdown);
  }

  public destroy(): void {
    friendWebSocketManager.disconnect();
  }
}
